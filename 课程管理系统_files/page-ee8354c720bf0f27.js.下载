(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[520],{283:(e,t,r)=>{"use strict";r.d(t,{A:()=>I,O:()=>_});var s=r(5155),o=r(2115),a=r(5695),l=r(9385),n=r(9959),i=r(8508);let E=(0,o.createContext)(void 0),c={ADMIN:{id:"admin",name:"管理员",permissions:[l.J.VIEW_WARNINGS,l.J.VIEW_SCHEDULE,l.J.VIEW_LESSON_TABLE,l.J.VIEW_CARD,l.J.FILE_COMPLAINT,l.J.EDIT_PROFILE,l.J.VIEW_BOOK_LOCKER,l.J.VIEW_PASTPAPER_TEXTBOOKS,l.J.VIEW_WEEKEND_PLAN,l.J.VIEW_CERTIFICATE_APPLY,l.J.VIEW_EXIT_PERMIT,l.J.VIEW_CLASS_SIGNUP,l.J.VIEW_SERVICE,l.J.VIEW_LATE_CASHIN,l.J.VIEW_REMARKING,l.J.VIEW_EXAM_WITHDRAWAL,l.J.VIEW_SCORE_REPORT,l.J.VIEW_TEXTBOOK,l.J.VIEW_NOTIFICATION,l.J.VIEW_EXAM_SIGNUP,l.J.VIEW_COMMITMENT]},TEACHER:{id:"teacher",name:"教师",permissions:[l.J.VIEW_WARNINGS,l.J.VIEW_SCHEDULE,l.J.VIEW_LESSON_TABLE,l.J.VIEW_CARD,l.J.FILE_COMPLAINT,l.J.EDIT_PROFILE,l.J.VIEW_BOOK_LOCKER,l.J.VIEW_PASTPAPER_TEXTBOOKS,l.J.VIEW_WEEKEND_PLAN,l.J.VIEW_CERTIFICATE_APPLY,l.J.VIEW_EXIT_PERMIT,l.J.VIEW_CLASS_SIGNUP,l.J.VIEW_SERVICE,l.J.VIEW_LATE_CASHIN,l.J.VIEW_REMARKING,l.J.VIEW_EXAM_WITHDRAWAL,l.J.VIEW_SCORE_REPORT,l.J.VIEW_TEXTBOOK,l.J.VIEW_NOTIFICATION,l.J.VIEW_EXAM_SIGNUP,l.J.VIEW_COMMITMENT]},STUDENT:{id:"student",name:"学生",permissions:[l.J.VIEW_SCHEDULE,l.J.VIEW_LESSON_TABLE,l.J.VIEW_WARNINGS,l.J.VIEW_CARD,l.J.FILE_COMPLAINT,l.J.EDIT_PROFILE,l.J.VIEW_BOOK_LOCKER,l.J.VIEW_PASTPAPER_TEXTBOOKS,l.J.VIEW_WEEKEND_PLAN,l.J.VIEW_CERTIFICATE_APPLY,l.J.VIEW_EXIT_PERMIT,l.J.VIEW_CLASS_SIGNUP,l.J.VIEW_SERVICE,l.J.VIEW_LATE_CASHIN,l.J.VIEW_REMARKING,l.J.VIEW_EXAM_WITHDRAWAL,l.J.VIEW_SCORE_REPORT,l.J.VIEW_TEXTBOOK,l.J.VIEW_NOTIFICATION,l.J.VIEW_EXAM_SIGNUP,l.J.VIEW_COMMITMENT]},PRE_STUDENT:{id:"pre_student",name:"报名学生",permissions:[l.J.INTERVIEW,l.J.MY_PROFILE,l.J.TEST_SCORE,l.J.MY_TEST,l.J.INTERVIEW]}};function _(e){let{children:t}=e,[l,_]=(0,o.useState)(null),[I,d]=(0,o.useState)(!0),m=(0,a.useRouter)();(0,o.useEffect)(()=>{!async function(){try{d(!0);let e=await n.y.getUserInfo();if(200===e.code&&e.data){let t=e.data,r={id:"unknown",name:"未知",permissions:[]};1===t.type?r=c.STUDENT:4===t.type&&(r=c.PRE_STUDENT);let s={id:String(t.id),username:String(t.name),role:r,data:t};_(s),localStorage.setItem("user",JSON.stringify(s))}else _(null),localStorage.removeItem("user"),localStorage.removeItem("token"),m.push("/login")}catch(e){console.error("检查登录状态失败:",e),_(null),localStorage.removeItem("user"),localStorage.removeItem("token"),m.push("/login")}finally{d(!1)}}()},[m]);let u=async(e,t)=>{try{let r=await n.y.login({username:e,password:t});if(200!==r.code||!r.token)throw Error(r.message||"登录失败");r.token&&localStorage.setItem("token",r.token);let s=(await n.y.getUserInfo()).data,o={id:"unknown",name:"未知",permissions:[]};1===s.type?o=c.STUDENT:4===s.type&&(o=c.PRE_STUDENT);let a={id:String(s.id),username:s.name,role:o,data:s};_(a),localStorage.setItem("user",JSON.stringify(a)),await (0,i.iO)(s,m)}catch(e){throw console.error("登录失败:",e),e}},S=async()=>{try{let e=await n.y.logout();if(200!==e.code)throw Error(e.message||"退出失败")}catch(e){console.error("退出异常:",e)}finally{_(null),localStorage.removeItem("user"),localStorage.removeItem("token");let{notifyMiniProgramLogout:e}=await r.e(48).then(r.bind(r,4048));e(),setTimeout(()=>{m.push("/login")},0)}};return(0,s.jsx)(E.Provider,{value:{user:l,login:u,logout:S,hasPermission:e=>!!l&&l.role.permissions.includes(e)},children:I?(0,s.jsx)("div",{children:"加载中..."}):t})}function I(){let e=(0,o.useContext)(E);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},3564:(e,t,r)=>{Promise.resolve().then(r.bind(r,9690))},9385:(e,t,r)=>{"use strict";r.d(t,{J:()=>s});let s={VIEW_DASHBOARD:"view_dashboard",VIEW_SCHEDULE:"view_schedule",VIEW_LESSON_TABLE:"view_lesson_table",VIEW_PASTPAPER_TEXTBOOKS:"view_pastpaper_textbooks",VIEW_BOOK_LOCKER:"view_book_locker",VIEW_WARNINGS:"view_warnings",VIEW_CARD:"view_card",FILE_COMPLAINT:"file_complaint",EDIT_PROFILE:"edit_profile",MY_PROFILE:"my_profile",VIEW_WEEKEND_PLAN:"view_weekend_plan",VIEW_CERTIFICATE_APPLY:"view_certificate_apply",VIEW_EXIT_PERMIT:"view_exit_permit",VIEW_CLASS_SIGNUP:"view_class_signup",VIEW_SERVICE:"view_service",VIEW_LATE_CASHIN:"view_late_cashin",VIEW_REMARKING:"view_remarking",VIEW_EXAM_WITHDRAWAL:"view_exam_withdrawal",VIEW_SCORE_REPORT:"view_score_report",TEST_SCORE:"test_score",VIEW_TEXTBOOK:"view_textbook",VIEW_NOTIFICATION:"view_notification",VIEW_EXAM_SIGNUP:"view_exam_signup",MY_TEST:"my_test",INTERVIEW:"interview",VIEW_COMMITMENT:"view_commitment"}},9690:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>I});var s=r(5594),o=r(376),a=r(5155),l=r(2177),n=r(2115),i=r(283),E=r(5695),c=r(8508);let _={USERNAME:"saved_username",PASSWORD:"saved_password",REMEMBER_ME:"remember_me"};function I(){let{register:e,handleSubmit:t,formState:{isSubmitting:r},setValue:I}=(0,l.mN)(),[d,m]=(0,n.useState)(!1),[u,S]=(0,n.useState)(""),[g,x]=(0,n.useState)(!1),T=(0,n.useRef)(!1),{login:p}=(0,i.A)(),W=(0,E.useRouter)(),N=(0,E.useSearchParams)();(0,n.useEffect)(()=>{let e=localStorage.getItem(_.USERNAME),t=localStorage.getItem(_.PASSWORD);"true"===localStorage.getItem(_.REMEMBER_ME)&&e&&t&&(I("username",e),I("password",t),m(!0))},[I]),(0,n.useEffect)(()=>{if(T.current)return;let e=window.navigator.userAgent.toLowerCase().includes("miniprogram"),t=N.get("token"),r=localStorage.getItem("token"),s=t||r,o=()=>{var t;if(e&&(null===(t=window.wx)||void 0===t?void 0:t.miniProgram))try{window.wx.miniProgram.redirectTo({url:"/pages/login/login"})}catch(e){console.error("跳转小程序登录页失败:",e)}};(async()=>{if(!s){console.log(e?"小程序环境无token，跳转到小程序登录页":"浏览器环境无token，停留在登录页"),o();return}try{x(!0),S(""),T.current=!0,t&&localStorage.setItem("token",t);let e=await (0,c.ug)();200===e.code&&e.data?(console.log("Token验证成功，正在跳转..."),(0,c.iO)(e.data,W,!0)):(console.error("Token验证失败:",e.message),localStorage.removeItem("token"),T.current=!1,S("Token验证失败，请重新登录"),o())}catch(e){console.error("Token验证异常:",e),localStorage.removeItem("token"),T.current=!1,S("登录验证失败，请重新登录"),o()}finally{x(!1)}})()},[N,W]);let A=async e=>{try{S(""),await p(e.username,e.password),d?(localStorage.setItem(_.USERNAME,e.username),localStorage.setItem(_.PASSWORD,e.password),localStorage.setItem(_.REMEMBER_ME,"true")):(localStorage.removeItem(_.USERNAME),localStorage.removeItem(_.PASSWORD),localStorage.removeItem(_.REMEMBER_ME))}catch(e){console.error("登录异常:",e),S(e instanceof Error?e.message:"登录失败，请稍后重试")}};return(0,a.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 p-6",children:(0,a.jsx)("div",{className:"w-[480px] bg-white/95 backdrop-blur-sm rounded-xl shadow-2xl",children:(0,a.jsxs)("div",{className:"px-14 py-12 space-y-14",children:[(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h2",{className:"text-center text-3xl font-bold text-gray-900",children:"课程管理系统"}),(0,a.jsx)("p",{className:"text-center text-[15px] text-gray-600",children:"请登录您的账号"})]}),u&&(0,a.jsx)("div",{className:"bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-[14px]",children:u}),g&&(0,a.jsxs)("div",{className:"bg-blue-50 border border-blue-200 text-blue-600 px-4 py-3 rounded-lg text-[14px] flex items-center justify-center",children:[(0,a.jsxs)("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"正在验证登录凭证..."]}),(0,a.jsxs)("form",{className:"space-y-6",onSubmit:t(A),children:[(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{htmlFor:"username",className:"block text-[15px] font-medium text-gray-700",children:"用户名"}),(0,a.jsx)("input",(0,o._)((0,s._)({},e("username")),{id:"username",name:"username",type:"text",required:!0,className:"block w-full px-4 py-3 text-[15px] border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 ease-in-out hover:border-blue-400",placeholder:"请输入用户名"}))]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{htmlFor:"password",className:"block text-[15px] font-medium text-gray-700",children:"密码"}),(0,a.jsx)("input",(0,o._)((0,s._)({},e("password")),{id:"password",name:"password",type:"password",required:!0,className:"block w-full px-4 py-3 text-[15px] border border-gray-300 rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 ease-in-out hover:border-blue-400",placeholder:"请输入密码"}))]})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2.5",children:[(0,a.jsx)("input",{id:"remember-me",name:"remember-me",type:"checkbox",checked:d,onChange:e=>m(e.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded cursor-pointer"}),(0,a.jsx)("label",{htmlFor:"remember-me",className:"text-[15px] text-gray-700 cursor-pointer",children:"记住我"})]}),(0,a.jsx)("a",{href:"#",className:"text-[15px] font-medium text-blue-600 hover:text-blue-500 transition-colors",children:"忘记密码？"})]}),(0,a.jsxs)("button",{type:"submit",disabled:r||g,className:"w-full flex justify-center items-center py-3 px-4 text-[15px] font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg",children:[r?(0,a.jsxs)("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}):null,r?"登录中...":"登录"]})]})]})})})}},9959:(e,t,r)=>{"use strict";r.d(t,{y:()=>o});var s=r(8508);let o={login:s.iD,logout:s.ri,getUserInfo:s.ug,getMyExams:s.hd,getAllExams:s.xV,signupExam:s.Oh,updateEdexcelNumber:s.L9,updateCieNumber:s.wW,getExamPayLink:s.mF,getStudentSalesInfo:s.e7,updateStudentSalesInfo:s.BE}}},e=>{var t=t=>e(e.s=t);e.O(0,[243,508,441,684,358],()=>t(3564)),_N_E=e.O()}]);
//# sourceMappingURL=page-ee8354c720bf0f27.js.map